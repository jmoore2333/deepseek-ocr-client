#!/usr/bin/env node
/* eslint-disable no-console */
const fs = require('fs');
const path = require('path');
const { spawnSync } = require('child_process');

const projectRoot = path.resolve(__dirname, '..');
const distDir = path.join(projectRoot, 'dist');

function run(command, args, options = {}) {
  const result = spawnSync(command, args, {
    cwd: projectRoot,
    stdio: 'inherit',
    env: {
      ...process.env,
      CSC_IDENTITY_AUTO_DISCOVERY: 'false'
    },
    ...options
  });
  if (result.error) {
    console.error(`[build-smoke] Failed to execute ${command}: ${result.error.message}`);
    process.exit(1);
  }
  if (result.status !== 0) {
    process.exit(result.status || 1);
  }
}

function getElectronBuilderInvocation() {
  const cliPath = path.join(projectRoot, 'node_modules', 'electron-builder', 'out', 'cli', 'cli.js');
  return {
    command: process.execPath,
    args: [cliPath]
  };
}

function getPlatformFlag() {
  if (process.platform === 'darwin') return '--mac';
  if (process.platform === 'win32') return '--win';
  return '--linux';
}

function assertUnpackedArtifact() {
  if (!fs.existsSync(distDir)) {
    throw new Error('dist/ directory was not generated by electron-builder');
  }

  const entries = fs.readdirSync(distDir, { withFileTypes: true });
  const unpackedDir = entries.find((entry) => {
    if (!entry.isDirectory()) return false;
    if (entry.name.includes('unpacked')) return true;
    if (entry.name === 'mac') return true;
    return entry.name.startsWith('mac-');
  });

  if (!unpackedDir) {
    throw new Error('No unpacked build output found in dist/');
  }

  console.log(`[build-smoke] Found unpacked output: dist/${unpackedDir.name}`);
}

console.log('[build-smoke] Running electron-builder --dir for current host platform...');
const builderInvocation = getElectronBuilderInvocation();
run(builderInvocation.command, [...builderInvocation.args, '--dir', '--publish', 'never', getPlatformFlag()]);
assertUnpackedArtifact();
console.log('[build-smoke] Build smoke test passed.');
